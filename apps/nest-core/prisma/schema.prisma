datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  searchConfigs SearchConfig[]
}

model Category {
  id        String   @id
  source    String   @default("olx")
  name      String
  parentId  String?
  parent    Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryHierarchy")
  
  @@unique([id, source])
}

model Location {
  id        String   @id
  source    String   @default("olx")
  name      String
  type      String   // 'city' or 'region'
  parentId  String?
  parent    Location? @relation("LocationHierarchy", fields: [parentId], references: [id])
  children  Location[] @relation("LocationHierarchy")
  
  @@unique([id, source])
}

model SearchConfig {
  id            String   @id @default(uuid())
  source        String   @default("olx") // "olx", "ebay", "allegro"
  query         String
  
  // Generic JSON storage for provider-specific filters
  // For OLX: { categoryId: "...", locationId: "...", radius: 0 }
  // For eBay: { categoryId: "...", listingType: "Auction", itemLocation: "..." }
  parameters    Json     @default("{}")
  
  isActive      Boolean  @default(true)
  lastRunAt     DateTime?
  checkInterval Int      @default(3600) // seconds
  
  offers        ScrapedOffer[]
  
  userId        Int
  user          User     @relation(fields: [userId], references: [id])

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ScrapedOffer {
  id            String   @id @default(uuid())
  externalId    String   // Unique ID from OLX
  searchConfigId String
  searchConfig  SearchConfig @relation(fields: [searchConfigId], references: [id], onDelete: Cascade)
  
  title         String
  url           String
  thumbnailUrl  String?
  description   String?
  
  detectedAt    DateTime @default(now())
  lastSeenAt    DateTime @default(now())
  isActive      Boolean  @default(true) // If not seen in recent scrapes, set false
  
  priceHistory  OfferPriceHistory[]

  // AI Analysis
  aiScore       Int?     // 0-100
  aiReasoning   Json?    // { en: "...", pl: "..." }

  @@unique([externalId, searchConfigId])
}

model OfferPriceHistory {
  id        String   @id @default(uuid())
  offerId   String
  offer     ScrapedOffer @relation(fields: [offerId], references: [id], onDelete: Cascade)
  
  price     Decimal
  currency  String
  recordedAt DateTime @default(now())
}
