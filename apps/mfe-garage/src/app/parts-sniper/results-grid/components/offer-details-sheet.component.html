<hlm-sheet side="right" #sheetRef>
    <ng-content></ng-content>
    <hlm-sheet-content *hlmSheetPortal="let ctx">
        <hlm-sheet-header>
            <div hlmSheetTitle>{{ offer()?.title }}</div>
        </hlm-sheet-header>
        
        <div class="px-4 gap-4 flex flex-col overflow-y-auto max-h-[calc(100vh-120px)]">
             <div class="flex justify-between items-center py-2 border-b">
                 <span class="text-muted-foreground">{{ 'results.price' | translate }}</span>
                 <span class="text-xl font-bold font-mono">{{ offer()?.priceHistory?.[0]?.price | currency:offer()?.priceHistory?.[0]?.currency:'symbol':'1.0-0' }}</span>
             </div>

             <div class="space-y-4">
                 <h4 class="font-medium">{{ 'results.analysis' | translate }}</h4>
                 @if (offer(); as currentOffer) {
                   <div class="p-4 rounded-lg border bg-muted/40 text-sm leading-relaxed" [ngClass]="getScoreClass(currentOffer.aiScore || 0)">
                       <div class="flex items-center justify-between mb-4">
                           <span class="font-bold">{{ 'results.score' | translate }}</span>
                           <span class="text-xl font-bold">{{ currentOffer.aiScore }}/100</span>
                       </div>
                       
                       @if (aiReasoning(); as reasoning) {
                           @if (getSummary(reasoning); as summary) {
                               <p class="mb-4 font-medium">{{ summary }}</p>
                           }

                           <div class="grid gap-4 sm:grid-cols-2">
                               @if (reasoning.pros?.length) {
                                   <div>
                                       <h5 class="font-semibold text-green-600 mb-2 flex items-center gap-1">
                                           <ng-icon hlmIcon name="lucideCheck" size="sm" /> Pros
                                       </h5>
                                       <ul class="list-disc pl-4 space-y-1 text-xs">
                                           @for (pro of reasoning.pros; track $index) {
                                               <li>{{ pro }}</li>
                                           }
                                       </ul>
                                   </div>
                               }
                               
                               @if (reasoning.cons?.length) {
                                   <div>
                                       <h5 class="font-semibold text-red-600 mb-2 flex items-center gap-1">
                                           <ng-icon hlmIcon name="lucideX" size="sm" /> Cons
                                       </h5>
                                       <ul class="list-disc pl-4 space-y-1 text-xs">
                                           @for (con of reasoning.cons; track $index) {
                                               <li>{{ con }}</li>
                                           }
                                       </ul>
                                   </div>
                               }
                           </div>

                           @if (reasoning.market_analysis) {
                               <div class="mt-4 pt-4 border-t border-dashed border-gray-300">
                                   <h5 class="font-semibold mb-1 text-xs uppercase tracking-wide text-muted-foreground">Market Analysis</h5>
                                   <p class="text-xs">{{ reasoning.market_analysis }}</p>
                               </div>
                           }
                       } @else {
                           <p class="text-muted-foreground italic">No detailed analysis available.</p>
                       }
                   </div>
                 }
             </div>

             <div class="space-y-2">
                <h4 class="font-medium">{{ 'results.details' | translate }}</h4>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div class="text-muted-foreground">{{ 'results.detected' | translate }}</div>
                    <div class="text-right">{{ offer()?.detectedAt | date:'medium' }}</div>
                    
                    <div class="text-muted-foreground">{{ 'results.lastSeen' | translate }}</div>
                    <div class="text-right">{{ offer()?.lastSeenAt | date:'medium' }}</div>
                    
                    <div class="text-muted-foreground">{{ 'results.offerId' | translate }}</div>
                    <div class="text-right font-mono text-xs truncate" title="{{ offer()?.externalId }}">{{ offer()?.externalId }}</div>
                </div>
             </div>

             @if (offer()?.description) {
                 <div class="space-y-2">
                     <h4 class="font-medium">{{ 'results.description' | translate }}</h4>
                     <p class="text-sm text-muted-foreground whitespace-pre-wrap">{{ offer()?.description }}</p>
                 </div>
             }
        </div>

        <hlm-sheet-footer>
             <a hlmBtn class="w-full sm:w-auto" [href]="offer()?.url" target="_blank">
                Open on OLX <ng-icon hlmIcon name="lucideExternalLink" size="sm" class="ml-2 h-4 w-4" />
             </a>
        </hlm-sheet-footer>
    </hlm-sheet-content>
</hlm-sheet>
