<div class="h-full flex flex-col bg-card rounded-xl border overflow-hidden">
  <div class="p-6 pb-4 border-b">
    <h2 class="text-xl font-bold tracking-tight">Watchlist</h2>
    <p class="text-xs text-muted-foreground mt-1">Manage automated search queries</p>
  </div>
  
  <div class="flex-1 overflow-y-auto p-4 space-y-4">
    <!-- List of Configs -->
    <ul class="space-y-3">
      @for (config of configs(); track config.id) {
        <li class="group relative bg-card border rounded-lg p-3 hover:border-primary/50 hover:shadow-sm transition-all cursor-pointer" (click)="selectConfig(config)">
          <div class="flex justify-between items-start">
            <div class="pr-6">
              <h3 class="font-semibold line-clamp-1 break-all">{{ config.query }}</h3>
              <div class="flex flex-wrap gap-1 mt-1.5">
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-secondary text-secondary-foreground border border-border">
                  {{ getCategoryName(config.categoryId) }}
                </span>
                @if (config.locationId) {
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-secondary text-secondary-foreground border border-border">
                    {{ getLocationName(config.locationId) }}
                  </span>
                }
              </div>
              <div class="mt-2 flex items-center text-xs text-muted-foreground">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                Every {{ config.checkInterval / 3600 }}h
              </div>
            </div>
            
            <button hlmBtn variant="ghost" size="icon-xs" (click)="deleteConfig(config.id); $event.stopPropagation()" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-destructive hover:text-destructive hover:bg-destructive/10">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
          </div>
        </li>
      }
      
      @if (configs().length === 0) {
        <li class="text-center py-8 text-sm text-muted-foreground border-2 border-dashed rounded-lg bg-muted/50">
          No active searches
        </li>
      }
    </ul>
  </div>

  <div class="p-4 bg-muted/50 border-t">
    <h3 class="text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-3">Add New Search</h3>
    <div class="space-y-3">
      <div>
        <input hlmInput [ngModel]="newConfig().query" (ngModelChange)="setQuery($event)" placeholder="Search Query (e.g. E55 AMG)" class="w-full bg-background" />
      </div>
      
      <div class="flex flex-col gap-3">
        <div class="flex gap-2 w-full">
          <select hlmInput [ngModel]="newConfig().categoryId" (ngModelChange)="setCategoryId($event)" class="flex-1 bg-background truncate">
            <option value="">Select Category</option>
            @for (cat of categories(); track cat.id) {
              <option [value]="cat.id">{{ cat.name }}</option>
            }
          </select>
          <button hlmBtn variant="outline" size="icon" (click)="openAddCategoryDialog()" class="bg-background shrink-0" title="Add Category ID">
             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
          </button>
        </div>

        <div class="grid grid-cols-2 gap-2">
           <select hlmInput [ngModel]="selectedRegionId()" (ngModelChange)="setRegionId($event)" class="bg-background col-span-2 sm:col-span-1 truncate">
             <option value="">Any Region</option>
             @for (reg of regions(); track reg.id) {
               <option [value]="reg.id">{{ reg.name }}</option>
             }
           </select>
           
           <select hlmInput [ngModel]="selectedCityId()" (ngModelChange)="setCityId($event)" class="bg-background col-span-2 sm:col-span-1 truncate">
             <option value="">Any City</option>
             @for (city of filteredCities(); track city.id) {
               <option [value]="city.id">{{ city.name }}</option>
             }
           </select>
        </div>
        
        @if (selectedCityId()) {
            <div class="flex items-center gap-2">
                <span class="text-xs text-muted-foreground whitespace-nowrap">Dist (km):</span>
                <div class="flex flex-wrap gap-1">
                    @for (rad of radii; track rad) {
                        <button 
                            type="button"
                            (click)="setRadius(rad)"
                            [class.bg-primary]="newConfig().radius === rad"
                            [class.text-primary-foreground]="newConfig().radius === rad"
                            class="px-2 py-1 text-xs border rounded transition-colors hover:bg-muted"
                        >{{ rad }}</button>
                    }
                </div>
            </div>
        }
        
        <div class="flex justify-end gap-2">
          <button hlmBtn variant="ghost" size="sm" (click)="openAddLocationDialog()" class="text-xs">
             Manage Locations...
          </button>
        </div>
      </div>

      <button hlmBtn (click)="addConfig()" [disabled]="!newConfig().query" class="w-full">
        Monitor Query
      </button>
    </div>
  </div>
</div>

<hlm-dialog [state]="categoryDialogState()" (closed)="closeCategoryDialog()">
  <hlm-dialog-content *brnDialogContent="let ctx">
    <hlm-dialog-header>
      <h3 hlmDialogTitle>Add New Category</h3>
      <p hlmDialogDescription>Enter the category details from the OLX URL.</p>
    </hlm-dialog-header>
    <div class="grid gap-4 py-4">
      <div class="grid grid-cols-4 items-center gap-4">
        <label hlmLabel for="cat-id" class="text-right">ID</label>
        <input hlmInput id="cat-id" [ngModel]="newCategory().id" (ngModelChange)="setNewCategoryId($event)" class="col-span-3" />
      </div>
      <div class="grid grid-cols-4 items-center gap-4">
        <label hlmLabel for="cat-name" class="text-right">Name</label>
        <input hlmInput id="cat-name" [ngModel]="newCategory().name" (ngModelChange)="setNewCategoryName($event)" class="col-span-3" />
      </div>
    </div>
    <hlm-dialog-footer>
       <button hlmBtn variant="ghost" (click)="closeCategoryDialog()">Cancel</button>
      <button hlmBtn (click)="saveCategory()">Save Category</button>
    </hlm-dialog-footer>
  </hlm-dialog-content>
</hlm-dialog>

<hlm-dialog [state]="locationDialogState()" (closed)="closeLocationDialog()">
  <hlm-dialog-content *brnDialogContent="let ctx">
    <hlm-dialog-header>
      <h3 hlmDialogTitle>Add New Location</h3>
      <p hlmDialogDescription>Enter the location details from the OLX URL.</p>
    </hlm-dialog-header>
    <div class="grid gap-4 py-4">
      <div class="grid grid-cols-4 items-center gap-4">
        <label hlmLabel for="loc-id" class="text-right">ID</label>
        <input hlmInput id="loc-id" [ngModel]="newLocation().id" (ngModelChange)="setNewLocationId($event)" class="col-span-3" />
      </div>
      <div class="grid grid-cols-4 items-center gap-4">
        <label hlmLabel for="loc-name" class="text-right">Name</label>
        <input hlmInput id="loc-name" [ngModel]="newLocation().name" (ngModelChange)="setNewLocationName($event)" class="col-span-3" />
      </div>
      <div class="grid grid-cols-4 items-center gap-4">
        <label hlmLabel for="loc-type" class="text-right">Type</label>
        <select hlmInput id="loc-type" [ngModel]="newLocation().type" (ngModelChange)="setNewLocationType($event)" class="col-span-3 bg-background">
            <option value="region">Region</option>
            <option value="city">City</option>
        </select>
      </div>
      @if (newLocation().type === 'city') {
          <div class="grid grid-cols-4 items-center gap-4">
            <label hlmLabel for="loc-parent" class="text-right">Region</label>
            <select hlmInput id="loc-parent" [ngModel]="newLocation().parentId" (ngModelChange)="setNewLocationParent($event)" class="col-span-3 bg-background">
                <option value="">None / Unknown</option>
                @for (reg of regions(); track reg.id) {
                    <option [value]="reg.id">{{ reg.name }}</option>
                }
            </select>
          </div>
      }
    </div>
    <hlm-dialog-footer>
       <button hlmBtn variant="ghost" (click)="closeLocationDialog()">Cancel</button>
      <button hlmBtn (click)="saveLocation()">Save Location</button>
    </hlm-dialog-footer>
  </hlm-dialog-content>
</hlm-dialog>
